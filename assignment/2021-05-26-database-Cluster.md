# Cluster, Clustering 개념, 목적, 구성사례

```
- WEB, WAS, DB의 관점에서
```

## 1. Cluster, Clustering 란?

### 개념

- 컴퓨터 클러스터란 여러 대의 컴퓨터들이 연결되어서 하나의 시스템처럼 동작하는 컴퓨터들의 집합을 말한다. 여러개의 객체를 하나로 모은다는 개념을 가지고 있다.

- 수퍼컴퓨터의 우수한 성능에도 불구하고 수퍼컴퓨터가 가지고 있는 보유 및 운영에 관한 단점을 해결하고자 하는 연구가 최근 수행되었는데, 그 중 하나가 클러스터(Cluster) 개념이다. 

- 클러스터란 여러 대의 컴퓨터를 네트워크를 통해 연결하여 하나의 단일 컴퓨터처럼 동작하도록 제작한 컴퓨터를 말한다. 

- 클러스터는 병렬 컴퓨터의 일종으로 1994년경 NASA의 Goddard Space Flight Center에서 여러 대의 486 PC를 네트워크로 연결하여 제작한 컴퓨터가 베어울프 클러스터이다. 

- 클러스터는 일반적으로 단일 컴퓨터보다 더 뛰어난 성능과 안정성을 제공하며, 비슷한 성능과 안정성을 제공하는 단일 컴퓨터보다 비용 면에서 훨씬 더 효율적이다.

### 목적

- 클러스터는 사용 목적에 따라 구현 방법 및 소프트웨어가 달라지며, 클러스터의 기능과 운영이 달라진다. 

- 따라서 클러스터는 그 사용 목적에 따라 `과학 계산용 클러스터`와 `부하분산 클러스터`로 나눌 수 있다. 

#### 과학 계산용 클러스터
- 과학 계산용 클러스터는 일반 범용컴퓨터로 계산하기 어려운 대규모 연산을 계산하는데 사용되고 있다. 

- 예를 들어 기상 예측, 핵폭발 시뮬레이션, 유체역학, 입자의 분자 역학 시뮬레이션 등의 분야에 사용된다. 

- 그러나 최근에는 클러스터 활용 범위가 넓어져서 이전에 수치 연산을 목적으로 사용되었던 클러스터를 3D 애니메이션 및 영화의 특수 효과에도 사용하고 있다. 

- 또한 과학 계산용 클러스터는 두 가지 형태로 구현될 수 있다. 

  -  우선 모든 노드의 하드디스크에 독립적으로 운영체제를 모두 설치하여 각 노드가 시스템에 필요한 파일 및 라이브러리를 자체적으로 해결할 수 있도록 구성하는 방법이다. 
  - 또 다른 방법은 서버 노드 한 대에만 하드디스크가 존재하여 다른 노드들은 서버 노드의 파일 시스템을 사용하는 diskless 클러스터 방법이 있다. 

- 과학 계산용 클러스터를 사용하기 위해서 MPI(Message Passing Interface)나 PVM(Parallel Virtual Machine)과 같은 라이브러리를 사용하여 코딩한 프로그램을 사용해야 한다. 

- 이러한 라이브러리를 사용하는 이유는 클러스터내의 노드 수만큼 작업을 분할하여 네트워크를 통해 메시지를 전달함으로써 병렬처리가 가능하도록 하기 위해서이다. 

#### 분산부하 클러스터

- 두 번째는 웹서버로 사용 가능한 부하분산 클러스터이다. 

- 컴퓨터 네트워크 및 월드 와이드 웹(World Wide Web)의 발전으로 인터넷 사용자 및 웹서버의 숫자는 기하급수적으로 증가하고 있다. 

- 그러나 컴퓨터 네트워크의 발달에도 불구하고 웹서버에 접속하는 사용자 수가 많아짐에 따라 웹서버에 병목현상이 발생하고 있다.

- 예를 들어 동일 시간대에 한 웹서버에 접속하는 사용자 수가 많게 되면 웹서버는 과부하로 인하여 작동을 멈추거나 속도가 느려진다. 
- 부하분산 클러스터는 단일 서버를 사용할 때 발생할 수 있는 부하를 다른 노드로 분산시켜 웹서버의 과부하를 해결할 수 있는 방법을 제공할 수 있다. 

- 부하분산 클러스터는 구현 방법에 따라 `DR(Direct Routing)`, `NAT(Network Address Translation)` 등으로 구현할 수 있다. 

  - DR(Direct Routing) 방식은 클라이언트에 들어온 요청을 부하분산 서버가 다른 컴퓨터에 분배하고, 요청을 할당받은 컴퓨터가 직접 응답을 하는 방법이다. 
  - NAT(Network Address Translation) 방식은 DR 방식과 비슷하지만 차이점은 클라이언트의 요청을 처리하는 컴퓨터는 응답을 부하분산 서버를 통해 목적지에 보내는 것이 다르며, NAT 방식과 DR 방식의 혼합된 형태로 구현하기도 한다.

- 그러나 부하분산 클러스터에서 부하분산 서버가 정지하거나 고장 발생의 경우 부하분산 클러스터가 작동을 멈추는 문제가 발생하게 된다.

- 이러한 문제점을 해결하는 방안으로 부하분산 서버를 감시하여 정지 및 고장 발생 시 클러스터 내의 다른 컴퓨터가 부하분산 서버 역할을 대신 할 수 있도록 하는 고가용성 클러스터가 함께 사용되기도 한다. 

### 동작 원리

- 클러스터로 구성된 컴퓨터가 수퍼컴퓨터와 대등한 성능을 발휘하기 위해서 여러 대의 컴퓨터가 단일 컴퓨터로 동작하도록 관리해야 하며, 각 노드간에 데이터 교환이 가능하도록 설정 해야한다. 

- 이러한 환경이 갖추어지면 어느 한 노드에서 다른 노드의 프로세스를 실행할 수 있도록 RSH(Remote Shell)이 작동할 수 있도록 해야 한다.

- 또한 MPI(Message Passing Interface)를 사용한 병렬 구조의 프로그램을 작성하여 실행시켜야 한다.

- 서버에서 병렬 프로그램을 실행하게 되면 MPI(Message Passing Interface) 데몬은 네트워크를 통해 각 노드로 작업을 분할하여 보내주며, 각 노드는 할당받은 작업을 처리하고 네트워크를 통해 결과를 서버에 돌려주게 된다. 

- 서버는 노드로부터 받은 결과를 조합하여 하나의 결과로 만들고 그 결과를 출력하게 된다. 

- 예를 들어 4대의 노드로 구성된 클러스터에서 1부터 n까지 더하는 병렬 프로그램을 실행할 경우, 

실행중인 MPI 데몬은 프로세스를 노드 수만큼 분할하여 각 노드에 작업을 할당하며, 

작업을 할당받은 노드는 작업을 처리하여 결과를 서버에 돌려주고, 서버는 각 결과를 다시 조합하여 1에서 n까지 더한 결과를 출력하게 된다.

출처: https://3dmpengines.tistory.com/1914 [3DMP]



## 2. Web Server, WAS Server : Session Cluster

- [3Tier Architecture](https://github.com/hennylee/kopo-03-linux/blob/main/post/2021-04-07-linux-3Tier-Architecture.md)

- 세션 클러스터링이란?

두 대 이상의 WAS를 이용하는 경우 로드 밸런싱(대용량 트래픽 처리시 분산시키는 것) 또는 failover(장애 발생시 예비시스템으로 자동전환, 서버 이중화), auto scaling(AWS에서 EC2 인스턴스를 자동으로 생성하고 삭제해주는 서비스) 등의 대체된 WAS에게도 세션이 공유하게 하는 기술 입니다.


- 세션 클러트서링 구성 방식

![image](https://user-images.githubusercontent.com/77392444/119743723-770b5c00-bec5-11eb-8cd8-0266628f532f.png)

1) WAS 간 구성
  - 세션 데이터별 Primary/BackUp 인스턴스를 지정하여 공유합니다.
  - 장점: 별도의 서버 인프라 없이 가능합니다.
  - 단점: 세션데이터의 백업 및 동기화 이슈, 장애 발생시 세션 복제의 이슈가 발생

2) 세션 Server 구성
  - 별도의 세션 서버 운영합니다.
  - 장점: 인스턴스간 세션 공유 설정이 용이합니다. 
  - 단점: 단일 장애 지점으로 장애시 복제를 구성해야 합니다. 성능이 좋지 못합니다.

3) 세션 데이터그리드 구성
  - 데이터그리드(JVM 프로세스 수를 늘리는것)에서 세션 정보를 저장하여 운영합니다.
  - 장점: 인스턴스와 애플리케이션 간 세션 공유가 용이합니다. Elastic 확장성과 안장성을 보장합니다. 메모리 기반 고성능.
  - 단점: 별도의 서버 구성으로 인한 비용 발생합니다, 관리포인트가 증가합니다. 
  - 예시: Tomcat , JBoss , WebLogic 

https://junshock5.tistory.com/91


## 3. DB Server : Cluster

- DB 클러스터도 컴퓨터 클러스터와 똑같은 맥락이다. DB 서버를 여러개 둔다고 생각하면 된다. 이에 대한 기본적인 장점은 서버 한 대가 죽어도 대비가 가능하다는 점이다.

- DB 클러스터와 비슷한 형태로 복수개의 독립된 DB가 서로 연계되는 경우가 있다. 이 DB는 서로 데이터를 읽거나 쓰는데, DBLink 또는 SQL/MED라고 한다.

- DB가 제공하는 기능중에서, 하나의 서버만으로 실현이 힘든 기능은 아래의 3가지이다.

  - 고가용성(Transactional)
  - 병렬처리(Analytic)
  - 성능향상(Online)

- 이러한 분류 방법은 오픈소스 관계형 DB시스템(RDBMS)의 하나인 Postgres의 코어 멤버인 Josh Berkus씨가 제안한 것이다. 현재 PostgreSQL을 사용한 클러스터 기술의 의론의 기반이 되고 있다.

- 고가용성(Transactional)

  - 무언가의 원인으로 DB가 충돌을 일으킨 경우라도, 단시간내에 실행을 재개가능할 뿐 아니라 데이터의 내용도 유실되지 않도록 하지 않으면 안되는 경우가 상황이 있다.
  - DB의 가용성이란, DB가 동작하고 있는 시간과 정지한 시간의 비율이다. 즉 99.9%또는 99.99%와 같이 표현한다. 
  - 가용성 99.99%란 연간 53분간 장애로 정지했음을 의미한다. 99.999%의 가용성이란 5분 정도 정지했음을 의미한다. 
  - 서버가 한대인 경우에 장애가 발생하면 미리 백업해 둔 데이터를 복원하고, 백업할 시점으로 부터 장애발생까지의 사이의 갱신로그(트랜젝션 로그)를 적용해서 복구해야 한다. 
  - 백업만으로는 백업한 이후에 발생한 변경을 날려 버리기 때문에 로그 등을 이용해서 복구해줄 필요가 있는 것이다.
  - 서버가 하드웨어적인 장애로 충돌한 경우, 새로운 서버로 교체한 후, 데이터베이스를 복원하고, 변경을 적용하게 된다. 이런 경우 소프트웨어 장애로 발생한 충돌에 비해 복구에 많은 시간이 걸리게 되어 수일까지 걸릴 수 있다. 이는 DB 운영에서 있을 수 없는 일이다.
  - 고가용성을 실형하려면 머저, DB 시스템을 구성할 서버나 스토레지 장비를 각각 2대 이상으로 구성해서, 만의 하나 어느쪽인가에 장애가 발생했다고 하더라도 단 시간내에 운용을 재개할 수 있도록 함을 의미한다. 이를 고가용성 클러스터라고 한다.
  - 고가용성 클러스터 구축시의 주의점은 어딘가 하 부분의 문제가 발생했을 때 복구하는데까지 오랜 시간이 걸리지 않도록 해야 한다는 점이다. 한 부분의 문제가 전체 시스템을 정지 시켜 버리는 곳을 Single Point Of Failure, SPOF라고 한다.

- 병렬처리(Analytic)
  - 데이터웨어하우스(DWH)를 정보원으로 하는 데이터 분석 어플리케이션(BI툴 등)과 같이, 데이터베이스의 내용을 분석하는데 사용하는 어플리케이션이 있다. 
  - 이런 경우 분석 대상의 데이터량이 너무 많고(수 기가, 테라 바이트), 사용하는 SQL문이 복잡(10개 이상의 테이블의 조합을 해서 통계를 내거나)하기 때문에 하나의 SQL문 실행에 막대한 시간이 걸린다. 
  - 이럴 경우 데이터베이스를 복수 개의 작은 단위로 분해해서 각각을 분석하는 처리를 병렬로 실행해서 결과를 통합하는 것 같은 방법을 사용할 수 있다.

- 성능향상(Online)
  - DB 유저수가 막대해 지는 케이스는, Web계 어플리케이션에서 자주 발생하는 케이스이다. 
  - 대규모 Web 어플리케이션의 경우 데이터베이스의 복사본을 만들어서 참조 처리는 복사한 DB를 사용하게 하는 방법으로 유저수가 많아지는 것을 대비할 수 있다.

- 이런식으로 복수개의 서버를 조합해서 위의 3가지 요구를 만족시키는 시스템의 구성형태를 DB 클러스터라고 한다.



- Master-Server 두대가 동일하게 작동하므로 서버중 한대가 Fail시 나머지 서버가 계속해서 임무 수행하는 방식


![image](https://user-images.githubusercontent.com/77392444/119746410-678f1180-becb-11eb-8902-e89a7085a0b9.png)

각 서버에 동일한 데이터가 저장되므로 어플리케이션 접근에 의한 부하를 분산시킬 수 있습니다.

- Master-Server 중 한대는 Primary Server로서 기능을 하다가 Fail시 Standby Server가 임무를 수행하는 방식


![image](https://user-images.githubusercontent.com/77392444/119746426-6f4eb600-becb-11eb-9e8e-89cd6636b659.png)


데이터 입력(Insert,Update, Delete)은 모두 마스터 서버에서 이루어지고, 데이터 불러오기(Select)는 슬레이브 서버들이 담당하게 되어 Select 쿼리가 많은 사이트에서 최적의 성능을 발휘할 수 있습니다.

실시간으로 데이터 복제가 가능하며, 서버에 거의 영향을 주지 않습니다.

## 4. Oracle RAC(Real Application Cluster)

![image](https://user-images.githubusercontent.com/77392444/119744659-6e1b8a00-bec7-11eb-83c3-9448b514fb01.png)

- Oracle RAC는 하나의 Database에 여러개의 Instance(= Node)로 구성하는 방식이다.

  - Database : 데이터를 저장하고 있는 창고의 역할

  - Instance : 창고의 데이터를 가져와 작업하는 작업장 

-  이는 Application에서 접속할 수 있는 통로는 여러개이고, DB는 하나인 형태.

- 1번 노드에서 트랜잭션을 수행하다가 노드가 죽었을 경우, 2번 노드에서 자동으로 수행한다.

- HA구성이란 High Availability의 약자로 고가용성이란 뜻이다.

![image](https://user-images.githubusercontent.com/77392444/119757812-77fdb700-bee0-11eb-861f-cbf97386e46a.png)

- HA구성은 이름 그대로 서버의 사용 가능시간을 최대한 늘이는 것이 목표인 서버 구성방법이다. 

- 두 대의 서버를 동일하게 구성해서 서버 1대는 Active로 두고 서버 1대는 Standby 로 설정해서 만약 Active 상태의 서버가 장애가 발생 할 경우 Srandby 상태의 서버가 즉시 Active 상태로 바뀌여서 투입되어 서비스 중단이 발생하지 않도록 조치되는 구성이다. 

- Oracle에서는 HA방식을 한 단계 더 발전시킨 OPS라는 방식을 도입하였다. 

- 8i까지는 OPS(Oracle Parallel Server)라고 하였다. (OPS에는 Interconnect가 없음)

- Cache Fusion (캐쉬 퓨전)이란? : Interconnect 을 통해 Instance 1과 2 를 연결하여 디스크를 거치지 않고 데이터를 교환하는 것

- Interconnect란? : 블록들이  이동하는  길이다.  

- Interconnect를  통해  이동하는  정보는  크게  
  - 1) Clusterware가  Cluster  를  유지하고  운영하기  위해 사용하는 정보와 
  - 2) 실제  데이터  블록, Parallel Query  관련  정보들이  있습니다.

- 일반적으로  Cluster를  유지하고  운영하는  정보인  `GCS/GES  관련  정보`는  256  bytes  정도로  아주 작지만, `실제  데이터  블록`은  DB_BLOCK_SIZE(10g/11g  기준으로  기본  크기는  8k)  나 NonStandard Block Size의  크기로 GCS/GES  정보에  비해  아주  큽니다. (실데 데이터 블록 크기 > Cluster를  유지하고  운영하는  정보)

- 이런  내용들이  얼마나  자주  왕래하느냐가  성능에  아주  중요한  영향을  주게  되어,  당연히  가급적이면 이동하는  양을  줄이는  것이  튜닝에  아주  핵심적인  관점이  된다. 

- 그래서 RAC  튜닝에서  Interconnect의  사용량을  줄이거나  혹은  Interconnect  의  속도를  높이는  것이  RAC  튜닝에서  아주  중요하다.


![image](https://user-images.githubusercontent.com/77392444/119744729-930ffd00-bec7-11eb-8ea7-a3f13484b87a.png)


